apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: cloudflared
  namespace: cloudflare
spec:
  interval: 10m
  chart:
    spec:
      chart: cloudflare-tunnel
      version: '>=0.3.0'
      sourceRef:
        kind: HelmRepository
        name: cloudflare
        namespace: flux-system

  # Pull tunnel secret from Kubernetes secret
  valuesFrom:
  - kind: Secret
    name: cloudflared-token
    valuesKey: token
    targetPath: cloudflare.secret

  values:
    replicaCount: 2

    # Use GitHub Container Registry to avoid DNS issues with Docker Hub
    image:
      repository: ghcr.io/cloudflare/cloudflared
      tag: "latest"

    cloudflare:
      account: "e21d62228b2de626a386eb1ed69292f5"
      tunnelId: "c4e17a2d-cdb2-4efb-ace9-682a6aa4304d"
      tunnelName: "homelab-k8s"

      # Ingress rules - what services to expose through the tunnel
      ingress:
        # Expose Silverbullet
        - hostname: sb.jlmitra.com
          service: http://silverbullet.silverbullet.svc.cluster.local:80

        # Expose Authelia authentication portal
        - hostname: auth.jlmitra.com
          service: http://authelia-svc.authelia.svc.cluster.local:9091

        # Catch-all rule (required) - returns 404 for unmatched requests
        - service: http_status:404
